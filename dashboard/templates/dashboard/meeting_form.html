{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.id %}Edit{% else %}Create{% endif %} Meeting | Ukombozini Women{% endblock %}

{% block extra_css %}
<link href="{% static 'vendor/select2/css/select2.min.css' %}" rel="stylesheet">
<link href="{% static 'vendor/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}" rel="stylesheet">
<style>
    .agenda-item {
        background-color: #f9f9f9;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid #4e73df;
        position: relative;
    }
    
    .delete-agenda-item {
        position: absolute;
        right: 15px;
        top: 15px;
        color: #e74a3b;
        cursor: pointer;
    }
    
    .agenda-time {
        color: #5a5c69;
        font-size: 0.9rem;
    }
    
    .drag-handle {
        cursor: move;
        margin-right: 10px;
        color: #4e73df;
    }
    
    #agenda-items-container:empty + #empty-agenda-message {
        display: block;
    }
    
    #empty-agenda-message {
        display: none;
        padding: 20px;
        text-align: center;
        background-color: #f1f1f1;
        border-radius: 5px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if form.instance.id %}Edit{% else %}Create{% endif %} Meeting
        </h1>
        <a href="{% url 'dashboard:meeting_list' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Meetings
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Meeting Details</h6>
                </div>
                <div class="card-body">
                    <form method="post" id="meeting-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">Title</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.title.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.meeting_type.id_for_label }}">Meeting Type</label>
                                    {{ form.meeting_type }}
                                    {% if form.meeting_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.meeting_type.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}">Status</label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.status.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.scheduled_date.id_for_label }}">Date</label>
                                    {{ form.scheduled_date }}
                                    {% if form.scheduled_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.scheduled_date.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.start_time.id_for_label }}">Start Time</label>
                                    {{ form.start_time }}
                                    {% if form.start_time.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.start_time.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.end_time.id_for_label }}">End Time</label>
                                    {{ form.end_time }}
                                    {% if form.end_time.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.end_time.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.location.id_for_label }}">Location</label>
                            {{ form.location }}
                            {% if form.location.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.location.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.description.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Hidden field to store agenda items as JSON -->
                        <input type="hidden" name="agenda_items" id="agenda_items_json" value="{% if form.instance.agenda_items %}{{ form.instance.agenda_items|safe }}{% else %}[]{% endif %}">
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                {% if form.instance.id %}Update{% else %}Create{% endif %} Meeting
                            </button>
                            <a href="{% url 'dashboard:meeting_list' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Participants Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Participants</h6>
                </div>
                <div class="card-body">
                    <!-- Group Selection -->
                    <div class="form-group">
                        <label for="{{ form.group.id_for_label }}">Select Group</label>
                        {{ form.group }}
                        <small class="form-text text-muted">If selected, all members of this group will be invited</small>
                    </div>
                    
                    <!-- Individual Members Selection -->
                    <div class="form-group">
                        <label for="{{ form.members.id_for_label }}">Select Individual Members</label>
                        {{ form.members }}
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    
                    <!-- Field Officers Selection -->
                    <div class="form-group">
                        <label for="{{ form.field_officers.id_for_label }}">Assign Field Officers</label>
                        {{ form.field_officers }}
                        <small class="form-text text-muted">Officers who will help manage this meeting</small>
                    </div>
                </div>
            </div>
            
            <!-- Agenda Items Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Agenda Items</h6>
                    <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addAgendaItemModal">
                        <i class="fas fa-plus fa-sm"></i> Add Item
                    </button>
                </div>
                <div class="card-body">
                    <div id="agenda-items-container">
                        <!-- Agenda items will be dynamically added here -->
                    </div>
                    <div id="empty-agenda-message">
                        <i class="fas fa-clipboard-list fa-2x mb-3 text-gray-300"></i>
                        <p>No agenda items added yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Agenda Item Modal -->
<div class="modal fade" id="addAgendaItemModal" tabindex="-1" aria-labelledby="addAgendaItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAgendaItemModalLabel">Add Agenda Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="agenda-item-form">
                    <div class="form-group">
                        <label for="agenda_time">Time (optional)</label>
                        <input type="time" class="form-control" id="agenda_time">
                    </div>
                    <div class="form-group">
                        <label for="agenda_title">Title</label>
                        <input type="text" class="form-control" id="agenda_title" required>
                    </div>
                    <div class="form-group">
                        <label for="agenda_presenter">Presenter (optional)</label>
                        <input type="text" class="form-control" id="agenda_presenter">
                    </div>
                    <div class="form-group">
                        <label for="agenda_duration">Duration (minutes, optional)</label>
                        <input type="number" class="form-control" id="agenda_duration" min="1">
                    </div>
                    <div class="form-group">
                        <label for="agenda_description">Description (optional)</label>
                        <textarea class="form-control" id="agenda_description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-agenda-item">Add Item</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/select2/js/select2.full.min.js' %}"></script>
<script src="{% static 'vendor/sortable/Sortable.min.js' %}"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2
        $('.select2').select2({
            theme: 'bootstrap4',
        });
        
        // Make agenda items sortable
        var sortable = new Sortable(document.getElementById('agenda-items-container'), {
            animation: 150,
            handle: '.drag-handle',
            onEnd: function() {
                updateAgendaItemsJson();
            }
        });
        
        // Load existing agenda items if they exist
        var existingAgendaItems = [];
        
        try {
            var agendaItemsJson = $('#agenda_items_json').val();
            if (agendaItemsJson && agendaItemsJson !== '[]') {
                existingAgendaItems = JSON.parse(agendaItemsJson);
            }
        } catch (e) {
            console.error("Error parsing agenda items:", e);
        }
        
        // Populate form with existing agenda items
        if (existingAgendaItems.length > 0) {
            existingAgendaItems.forEach(function(item) {
                addAgendaItemToContainer(item);
            });
        }
        
        // Save agenda item
        $('#save-agenda-item').click(function() {
            var time = $('#agenda_time').val();
            var title = $('#agenda_title').val();
            var presenter = $('#agenda_presenter').val();
            var duration = $('#agenda_duration').val();
            var description = $('#agenda_description').val();
            
            if (!title) {
                alert('Please enter a title for the agenda item.');
                return;
            }
            
            var agendaItem = {
                time: time,
                title: title,
                presenter: presenter,
                duration: duration,
                description: description
            };
            
            addAgendaItemToContainer(agendaItem);
            updateAgendaItemsJson();
            
            // Clear form
            $('#agenda_time').val('');
            $('#agenda_title').val('');
            $('#agenda_presenter').val('');
            $('#agenda_duration').val('');
            $('#agenda_description').val('');
            
            // Close modal
            $('#addAgendaItemModal').modal('hide');
        });
        
        // Delete agenda item
        $(document).on('click', '.delete-agenda-item', function() {
            $(this).closest('.agenda-item').remove();
            updateAgendaItemsJson();
        });
        
        // Function to add agenda item to the container
        function addAgendaItemToContainer(item) {
            var html = '<div class="agenda-item" data-time="' + (item.time || '') + '" ' +
                'data-title="' + (item.title || '') + '" ' +
                'data-presenter="' + (item.presenter || '') + '" ' +
                'data-duration="' + (item.duration || '') + '" ' +
                'data-description="' + (item.description || '') + '">' +
                '<i class="fas fa-grip-vertical drag-handle"></i>' +
                '<div class="row">';
            
            if (item.time) {
                html += '<div class="col-md-4"><div class="agenda-time">' + item.time + '</div></div>';
                html += '<div class="col-md-8">';
            } else {
                html += '<div class="col-md-12">';
            }
            
            html += '<h5>' + item.title + '</h5>';
            
            if (item.presenter) {
                html += '<div><strong>Presenter:</strong> ' + item.presenter + '</div>';
            }
            
            if (item.duration) {
                html += '<div><strong>Duration:</strong> ' + item.duration + ' minutes</div>';
            }
            
            if (item.description) {
                html += '<div><strong>Description:</strong> ' + item.description + '</div>';
            }
            
            html += '</div></div>' +
                '<i class="fas fa-times delete-agenda-item"></i>' +
                '</div>';
            
            $('#agenda-items-container').append(html);
        }
        
        // Function to update the hidden JSON field with agenda items
        function updateAgendaItemsJson() {
            var items = [];
            
            $('.agenda-item').each(function() {
                var item = {
                    time: $(this).data('time'),
                    title: $(this).data('title'),
                    presenter: $(this).data('presenter'),
                    duration: $(this).data('duration'),
                    description: $(this).data('description')
                };
                
                items.push(item);
            });
            
            $('#agenda_items_json').val(JSON.stringify(items));
        }
    });
</script>
{% endblock %} 